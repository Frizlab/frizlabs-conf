---
# AFAICT to remove the code duplication we have between paths and loop, we would
# have to create a new task and import this other task (because AFAIK we cannot
# define (actual, I’m aware of set_fact but don’t like it) variables in a task).
- include_tasks: "pkg_links_one_folder.yml"
  vars:
    # Mode is totally useless as it will be applied to the links…
    mode: "0644"
    extension_regex: ""
    dest: "{{ base_dest }}/{{ cur_dest }}"
    paths: "{{ packages_to_install | subelements('share_paths', skip_missing=True) | map(attribute='1') | selectattr('dest_folder', 'equalto', cur_dest) | sum(attribute='files', start=[]) }}"
  loop: "{{ packages_to_install | subelements('share_paths', skip_missing=True) | map(attribute='1.dest_folder') | unique | list }}"
  loop_control:
    loop_var: "cur_dest"

# vim: ts=2 sw=2 et
